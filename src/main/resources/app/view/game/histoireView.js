define("jquery underscore app/utils/utils app/utils/viewUtils text!app/template/game/histoire.html app/data/stories app/data/stories/gameOver".split(" "),function(f,k,l,m,n,p,q){return function(r,s){this.init=function(b,a){this.el=f(".histoire");this.parent=b;this.Textes=b.Textes;this.mediatheque=b.mediatheque;this.kongregateUtils=b.kongregateUtils;this.saveManager=b.saveManager;this.recompenseManager=b.recompenseManager;this.player=b.playerManager;this.didacticiel=a;this.alreadyPlayed=[];a?this.go("didacticiel-start",
!0):this.go(this.player.get("lieu"),!0)};this.go=function(b,a){var c=p.get(b);if(c){var d=this;f(".fight").fadeOut();f(".boutique").fadeOut();f(".quetes").fadeOut();f(".jeuGarde").fadeOut();f("carnet").removeClass("hide");f("loupe").removeClass("hide");this.el.fadeIn();c.before&&c.before(this);this.didacticiel||(c.music?this.playMusic("music/"+c.music):a&&this.playMusic(),this.player.data.lieu=b);this.currentLieu=c;k.templateSettings.variable="data";var e=k.template(n);this.el.html(e({text:this.Textes,
lieu:c,view:this}));m.verticalCenter();setTimeout(function(){d.showActions(function(){d.positionneActions()})},50);this.makeEvents()}else console.log("Erreur - le lieu n'existe pas",b)};this.playMusic=function(b){var a=this,c=b;if(!b){c=[];this.alreadyPlayed.length>=this.mediatheque.listStories.length&&(this.alreadyPlayed=[]);for(var d in this.mediatheque.listStories)b=this.mediatheque.listStories[d],-1==this.alreadyPlayed.indexOf(b)&&this.mediatheque.currentMusic!=b&&c.push(b);c=c[l.rand(0,c.length)]}this.alreadyPlayed.push(c);
this.mediatheque.play(c,null,function(){a.playMusic()})};this.positionneActions=function(){var b=this.el.find("action").length;this.el.find("action").each(function(a,c){a<b/2?f(this).addClass("gauche"):f(this).addClass("droite")})};this.makeEvents=function(){var b=this;this.el.find("action").click(function(){var a=f(this).attr("id");b.player.etatsManager.infligeEtats();b.hideActions(function(){var c=b.currentLieu.actions[a];c||console.log("Erreur - l'action n'existe pas pour ce lieu",b.currentLieu,
a);for(var d in c.action){var e=c.action[d];e.key?b.execute(e.key,e.params):e(b)}})});this.el.find("texte span").click(function(){var a=f(this).attr("key"),c=f(this).attr("suffixe");b.parent.glossaire(a,c)})};this.hideActions=function(b){this.el.find("action").css({top:"150%"});setTimeout(b,300)};this.showActions=function(b){this.el.find("action").css({top:"0%"});setTimeout(b,300)};this.execute=function(b,a){var c=this;switch(b){case "restart":this.parent.resetGame();break;case "score":this.recompenseManager.addSuccess(a[0]);
break;case "go":this.go(a[0]);break;case "gameOver":this.player.restore();var d=l.rand(1,q.length(),!0);this.go("gameOver"+d);break;case "restore":this.player.restore();break;case "reload":this.go(this.player.data.checkpoint);break;case "fight":var e=a[0],f=a[1],h=a[2],g=a[3],k=a[4],d=null;h&&(d=function(){c.go(h)});this.parent.fight(e,function(){c.go(f)},d,g,k);break;case "hurt":this.hurt(a[0]);break;case "gain":this.gain(a);break;case "gainOneTime":this.gain(a,!0);break;case "gainGold":this.gainGold(a[0]);
break;case "perte":for(d in a)this.player.removeEquipment(a[d]);break;case "depense":case "perteGold":d=a[0];this.player.addGold(-d);break;case "sound":this.mediatheque.playSound(a[0]+".wav");break;case "hasItem":e=a[0];d=a[1];g=a[2];this.player.hasAll(e)?this.go(d):g&&this.go(g);break;case "hasNoItem":e=a[0];g=a[1];d=a[2];this.player.hasNoOne(e)?this.go(g):d&&this.go(d);break;case "heal":this.player.addPercentLife(a[0]);break;case "healMG":d=a[0];this.player.addMana(d);break;case "upMG":d=a[0];this.player.unlockMana(d);
break;case "random":d=l.rand(0,a.length);this.go(a[d]);break;case "boutique":e=a[0];f=a[1];h=a[2];d=null;h&&(d=function(){c.go(h)});this.parent.boutique(e,function(){c.go(f)},d);break;case "jeu-garde":var d=a[0],m=a[1],e=a[2]?a[2]:100;if(this.player.get("gold")<e)return this.go("ville-garde-jeu-pauvre");this.parent.jeuGarde(d,function(){c.go(m)},function(){c.go("ville-garde-jeu-echec")},function(){c.go("ville-garde-jeu-retour")},e);break;case "quetes":this.parent.quetes(function(){c.go("ville-entree-panneau-quete-retour")});
break;case "step-quete":d=a[0];void 0==d&&(d=1);this.player.add("currentQuest.step",d);break;case "end-quete":this.finalizeQuest(a[0]);break;default:console.log("Erreur, l'action "+b+" n'existe pas.")}};this.startQuest=function(b){this.player.set("currentQuest.name",b.name);this.player.set("currentQuest.step",0);this.go(b.start)};this.finalizeQuest=function(b){this.player.finalizeQuest(b);this.go("ville-entree-retour-quete")};this.hurt=function(b){this.player.hurtPercent(b,!0);0>=this.player.get("life.current")&&
this.player.addLife(1)};this.gain=function(b,a){Array.isArray(b)||(b=[b]);if(!a||this.player.hasNoOne(b))for(var c in b)this.player.addEquipment(b[c])};this.gainGold=function(b){this.player.addGold(b)};this.checkActions=function(b){var a=!0,c;for(c in b)var d=b[c],a=a&&this.checkAction(d.key,d.params);return a};this.checkAction=function(b,a){switch(b){case "hasNoItem":return this.player.hasNoOne(a);case "hasItem":return this.player.hasAll(a);case "hasItemNb":return this.player.countItem(a[0])==a[1];
case "hasMG":var c=a[0];return this.player.get("mana.current")>=c;case "hasGold":return c=a[0],this.player.get("gold")>=c;default:return!0}};this.init(r,s)}});