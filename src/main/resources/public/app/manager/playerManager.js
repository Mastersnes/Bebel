define("jquery underscore app/utils/utils app/manager/levelManager app/manager/etatsManager app/data/items app/data/etats app/data/quetes".split(" "),function(k,s,e,n,p,h,t,q){return function(r){this.init=function(a){this.el="";this.parent=a;this.Textes=a.Textes;this.saveManager=a.saveManager;this.recompenseManager=a.recompenseManager;this.data=this.saveManager.load("player");this.restoreStates();this.options=this.saveManager.options();this.mediatheque=a.mediatheque;this.levelManager=new n(this);
this.etatsManager=new p(this);this.amountBuffer=[]};this.get=function(a){a=a.split(".");var b=this.data,c;for(c in a)if(b=b[a[c]],void 0==b)return null;return b};this.set=function(a,b){for(var c=a.split("."),d=this.data,e,g=0;g<c.length;g++)if(g==c.length-1?e=c[g]:d=d[c[g]],void 0==d)return null;d[e]=b};this.add=function(a,b){var c=this.get(a);this.set(a,c+b)};this.finalizeQuest=function(a){var b=q.get(this.get("currentQuest.name"));b?(void 0==a&&(a=this.get("currentQuest.step"),a=e.toPercent(a,b.steps)),
a=e.percent(b.price,a),this.addGold(a),this.data.quetesComplete.push(b.name),this.set("currentQuest.name",null),this.set("currentQuest.step",0)):console.log("Erreur, la quete "+this.get("currentQuest.name")+" n'existe pas")};this.bouclier=function(){var a=this.data.equipment.bouclier,b=this.data.equipment.currentBouclier;e.contains(a,b)||(console.log("Erreur bouclier - bouclier non possédé",b,a),this.data.equipment.currentBouclier="bras");return h.get("bouclier",b)};this.arme=function(){var a=this.data.equipment.arme,
b=this.data.equipment.currentArme;e.contains(a,b)||(console.log("Erreur arme - arme non possédée",b,a),this.data.equipment.currentArme="poing");return h.get("arme",b)};this.currentArme=function(){this.arme();return this.data.equipment.currentArme};this.currentBouclier=function(){this.bouclier();return this.data.equipment.currentBouclier};this.addEquipment=function(a,b){var c,d;b?(c=a,d=b):(d=a,c=h.get(d),c=c.type?c.type:"ifObj");"ifObj"!=c&&this.addAmountChange("+"+this.Textes.get(d),"equipment");
this.data.equipment[c].push(d);this.options.selectAuto&&("arme"==c?this.selectBetterArme(d):"bouclier"==c&&this.selectBetterBouclier(d))};this.removeEquipment=function(a,b){var c,d;b?(c=a,d=b):(d=a,c=h.get(d),c=c.type?c.type:"ifObj");if("poing"!=d&&"bras"!=d){var e=this.data.equipment[c].indexOf(d);-1<e?("ifObj"!=c&&this.addAmountChange("\x3cs\x3e"+this.Textes.get(d)+"\x3c/s\x3e","equipment"),this.data.equipment[c].splice(e,1),this.arme(),this.bouclier()):console.log("Erreur suppression - item non possédé",
c,d)}};this.selectArme=function(a){e.contains(this.data.equipment.arme,a)?this.data.equipment.currentArme=a:console.log("Erreur selection - arme non possédée",a)};this.selectBetterArme=function(a){var b=h.get("arme",a);if(b){var c=this.arme(),d=(b.degats[0]+b.degats[1])/2;b.lifeSteal&&(d+=(b.lifeSteal[0]+b.lifeSteal[1])/2);b=(c.degats[0]+c.degats[1])/2;c.lifeSteal&&(b+=(c.lifeSteal[0]+c.lifeSteal[1])/2);d>b&&this.selectArme(a)}else console.log("Erreur - Impossible de trouver l'arme",a)};this.selectBouclier=
function(a){e.contains(this.data.equipment.bouclier,a)?this.data.equipment.currentBouclier=a:console.log("Erreur selection - bouclier non possédé",a)};this.selectBetterBouclier=function(a){var b=h.get("bouclier",a);if(b){var c=this.bouclier();(b.defense[0]+b.defense[1])/2>(c.defense[0]+c.defense[1])/2&&this.selectBouclier(a)}};this.has=function(a){return e.contains(this.data.equipment.arme,a)?"arme":e.contains(this.data.equipment.bouclier,a)?"bouclier":e.contains(this.data.equipment.magie,a)?"magie":
e.contains(this.data.equipment.conso,a)?"conso":e.contains(this.data.equipment.clef,a)?"clef":e.contains(this.data.equipment.ifObj,a)?"ifObj":null};this.usableMagie=function(){if(!this.get("unlockMana"))return[];var a=[],b=this.data.mana.current,c;for(c in this.data.equipment.magie){var d=this.data.equipment.magie[c],e=h.get("magie",d);b>=e.manaCost&&a.push(d)}return a};this.getRandSoin=function(){var a=[],b;for(b in this.data.equipment.conso){var c=this.data.equipment.conso[b],d=h.get("conso",c);
d&&0<d.vie[1]?a.push(c):d||console.log("Erreur - le conso n'existe pas",c)}b=e.rand(0,a.length);return a[b]};this.hasAll=function(a){Array.isArray(a)||(a=[a]);var b=!0,c;for(c in a)var d=a[c],b=b&&this.has(d);return b};this.countItem=function(a){var b;(b=0+e.count(this.data.equipment.arme,a))||(b+=e.count(this.data.equipment.bouclier,a));b||(b+=e.count(this.data.equipment.magie,a));b||(b+=e.count(this.data.equipment.conso,a));b||(b+=e.count(this.data.equipment.clef,a));b||(b+=e.count(this.data.equipment.ifObj,
a));return b};this.hasNoOne=function(a){Array.isArray(a)||(a=[a]);for(var b in a)if(this.has(a[b]))return!1;return!0};this.use=function(a,b){b||(b=this);Array.isArray(b)||(b=[b]);if(e.contains(this.data.equipment.conso,a)){var c=h.get("conso",a),d;for(d in b){var f=b[d];if(c.degats){var g=this.data.attaque,g=e.rand(g+c.degats[0],g+c.degats[1],!0);0<g&&f.hurt(g,!0)}c.vie&&(g=e.rand(c.vie[0],c.vie[1],!0),0<g&&f.addPercentLife(g));c.mana&&(g=e.rand(c.mana[0],c.mana[1],!0),0<g&&f.addPercentMana(g));if(c.effet)for(d in c.effet)this.etatsManager.check(c.effet[d],
f);c.action&&c.action(this,f,this.fightView);c.offensif&&f.showDegats(c.anim)}this.mediatheque.playSound(c.sound+".wav");this.removeEquipment("conso",a);return!0}console.log("Erreur use - objet non possédé",a,b);return!1};this.spell=function(a,b){if(!this.get("unlockMana"))return!1;b||(b=this);Array.isArray(b)||(b=[b]);if(e.contains(this.data.equipment.magie,a)){var c=h.get("magie",a);if(c.manaCost<=this.get("mana.current")){this.addMana(-c.manaCost);for(var d in b){var f=b[d];if(c.vie){var g=e.rand(c.vie[0],
c.vie[1],!0);0<g&&f.addPercentLife(g)}g=0;c.degats&&(g=this.data.attaque,g=e.rand(c.degats[0]+g,c.degats[1]+g,!0),0<g&&f.hurt(g,!0,c.element));if(c.lifeSteal){var k=e.rand(c.lifeSteal[0],c.lifeSteal[1],!0);this.stealLife(k,g,f)}c.manaSteal&&(g=e.rand(c.manaSteal[0],c.manaSteal[1],!0),this.stealMana(g,f));c.action&&c.action(this,f,this.fightView);if(c.effet)for(d in c.effet)this.etatsManager.check(c.effet[d],f);c.offensif&&f.showDegats(c.anim)}this.mediatheque.playSound(c.sound+".wav")}else console.log("Erreur spell - pas assez de mana",
c,b)}else console.log("Erreur spell - sort non possédé",a,b)};this.attaque=function(a,b){Array.isArray(a)||(a=[a]);void 0==b&&(b=!0);var c=this.data.attaque,d=this.arme(),f=c+d.degats[0],c=c+d.degats[1],g=this.get("level"),h;for(h in a){var k=a[h],l=e.rand(f,c,!0);0>l&&(l=0);if(d.lifeSteal){var m=e.rand(d.lifeSteal[0],d.lifeSteal[1],!0);this.stealLife(m,l,k)}d.manaSteal&&(m=e.rand(d.manaSteal[0],d.manaSteal[1],!0),0<m&&this.steal("mana",k,m+g));k.hurt(l,b);k.showDegats(d.anim)}d.offensif=!0;this.mediatheque.playSound(d.sound+
".wav")};this.hurtPercent=function(a,b,c){a=Math.round(e.percent(this.data.life.max,a));this.hurt(a,b,c)};this.hurt=function(a,b,c){if(b){b=this.data.defense;var d=this.bouclier();b=e.rand(b+d.defense[0],b+d.defense[1],!0);a-=b}0>a&&(a=0);this.addLife(-a,c);return a};this.addPercentLife=function(a,b){a=Math.round(e.percent(this.data.life.max,a));this.addLife(a,b)};this.addLife=function(a,b){this.addAmountChange(a,"life",b);this.data.life.current+=a;0>this.data.life.current&&(this.data.life.current=
0);this.data.life.current>this.data.life.max&&(this.data.life.current=this.data.life.max)};this.addPercentMana=function(a){a=Math.round(e.percent(this.data.mana.max,a));this.addMana(a)};this.addMana=function(a){this.data.unlockMana&&(this.addAmountChange(a,"mana"),this.data.mana.current+=a,0>this.data.mana.current&&(this.data.mana.current=0),this.data.mana.current>this.data.mana.max&&(this.data.mana.current=this.data.mana.max))};this.unlockMana=function(a){this.data.unlockMana=!0;0>a&&(a=0);this.data.mana.max+=
a;this.addMana(this.data.mana.max)};this.addXp=function(a){0<a&&this.addAmountChange(a,"xp");this.levelManager.add(a)};this.levelUp=function(){this.recompenseManager.addSuccess("LevelEarn",this.data.level);this.data.attaque++;this.data.life.max+=25;this.data.unlockMana&&this.data.mana.max++;this.addLife(this.data.life.max);this.addMana(this.data.mana.max)};this.addGold=function(a){0<a&&this.addAmountChange(a,"gold");this.data.gold+=a;0>this.data.gold&&(this.data.gold=0);this.data.gold>e.MAX_GOLD&&
(this.data.gold=e.MAX_GOLD,this.recompenseManager.addSuccess("MaxGoldEarn"));this.recompenseManager.addSuccess("GoldEarn",this.data.gold)};this.achete=function(a){var b=h.get(a);if(b&&b.price){if(this.data.gold>=b.price)return this.addGold(-b.price),this.addEquipment(b.type,b.name),!0;console.log("Erreur achete - l'item est trop chere",a,b.price)}else console.log("Erreur achete - l'item n'existe pas ou n'a pas de prix",a);return!1};this.vend=function(a){if(this.data.gold>=e.MAX_GOLD)return!1;var b=
h.get(a);if(b&&b.price)return this.addGold(Math.round(0.5*b.price)),this.removeEquipment(b.type,b.name),!0;console.log("Erreur vend - l'item n'existe pas ou n'a pas de prix",a);return!1};this.stealMana=function(a,b){var c=b.get("mana.current"),c=Math.round(e.percent(c,a));0<c&&this.steal("mana",b,c)};this.stealLife=function(a,b,c){var d=c.get("life.current"),f=0;b?(f=Math.round(e.percent(b,a)),0<f&&this.addLife(f)):(f=Math.round(e.percent(d,a)),0<f&&this.steal("life",c,f))};this.steal=function(a,
b,c,d){switch(a){case "life":a=b.get("life.current");b.addLife(-c);a-=b.get("life.current");void 0!=d?this.addLife(e.rand(d,a,!0)):this.addLife(a);break;case "mana":a=b.get("mana.current");b.addMana(-c);a-=b.get("mana.current");void 0!=d?this.addMana(e.rand(d,a,!0)):this.addMana(a);break;case "gold":a=b.get("gold"),b.addGold(-c),a-=b.get("gold"),void 0!=d?this.addGold(e.rand(d,a,!0)):this.addGold(a)}};this.addAmountChange=function(a,b,c){c||(c="normal");this.amountBuffer.push({amount:a,type:b,element:c})};
this.showNextAmount=function(){if(!(0>=this.amountBuffer.length)){var a=this.amountBuffer[0];this.showAmountChange(a.amount,a.type,a.element);this.amountBuffer.splice(0,1)}};this.showAmountChange=function(a,b,c){var d=0;switch(b){case "life":d=e.rand(10,30,!0);0>a?(this.showHurtScreen(c),a+="pv"):0==a?(c="miss",a=this.Textes.get("rate"),d=0):a="+"+a+"pv";break;case "mana":0<a&&(a="+"+a);a+="pm";d=e.rand(35,45,!0);break;case "xp":0<a&&(a="+"+a);a+="xp";d=e.rand(55,65,!0);break;case "gold":0<a&&(a=
"+"+a),a+="po",d=e.rand(75,85,!0)}var f=k(".game hurts amountchanger:hidden:first");0<f.length?(f.removeAttr("style"),f.removeAttr("class"),f.removeAttr("element")):(f=k("\x3camountchanger\x3e\x3camount\x3e\x3c/amount\x3e\x3c/amountchanger\x3e"),k(".game hurts").append(f));f.find("amount").html(a);f.attr("class",b);f.attr("element",c);f.css({"margin-left":d+"%"});f.show();f.animate({top:"-50%",opacity:"0"},4E3,function(){f.hide()})};this.showDegats=function(){};this.showHurtScreen=function(a){var b=
k(".game hurts").find("hurt."+a);0==b.length&&(b=k(".game hurts hurt.normal"));b.fadeIn(100,function(){b.fadeOut(200)})};this.restore=function(){this.data.life.current=0;this.addPercentLife(70);50>e.toPercent(this.data.mana.current,this.data.mana.max)&&(this.data.mana.current=0,this.addPercentMana(50));this.data.buff=null;this.data.debuff=null};this.saveState=function(a){this.data.savesData[a]=this.get(a)};this.restoreStates=function(){for(var a in this.data.savesData)void 0!=a&&this.set(a,this.data.savesData[a]);
this.data.savesData={}};this.init(r)}});