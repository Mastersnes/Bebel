define("jquery underscore app/utils/utils app/utils/map app/utils/viewUtils text!app/template/game/jeuGarde.html app/manager/jeuGardeManager".split(" "),function(b,g,c,n,f,k,h){return function(l){this.init=function(a){this.el=b(".jeuGarde");this.parent=a;this.Textes=a.Textes;this.mediatheque=a.mediatheque;this.kongregateUtils=a.kongregateUtils;this.saveManager=a.saveManager;this.recompenseManager=a.recompenseManager;this.playerData=a.playerManager;this.garde=new h(this,"garde");this.player=new h(this,
"player");this.jeuGardeLaunch=!1;this.el.hide()};this.launch=function(a,m,d,c,e){this.jeuGardeLaunch=!0;b(".histoire").fadeOut();b(".boutique").fadeOut();b(".fight").fadeOut();b(".quetes").fadeOut();b(".ui").fadeOut();this.onWin=m;this.onFail=d;this.onAbandon=c;this.but=a;this.startMise=null!=e?e:100;this.nbWin=0;this.firstTime=!0;-1==this.but?this.el.find("legende #victoires").hide():(this.el.find("legende #victoires span#max").html(this.but),this.el.find("legende #victoires").show());this.render();
this.el.find("#accueil-jeu").hide();this.el.find("#plateau-jeu").hide();this.el.fadeIn();this.accueil()};this.accueil=function(){this.gameOver=!1;this.el.find("#accueil-jeu").fadeIn();this.el.find("#plateau-jeu").hide();f.verticalCenter();this.firstTime?this.el.find("#accueil-jeu texte").html(this.Textes.get("pokgard-debut")):this.el.find("#accueil-jeu texte").html(this.Textes.get("pokgard-win"))};this.launchGame=function(a){this.garde.initGame();this.player.initGame();var b=this;c.then(function(){b.el.find("#accueil-jeu").hide();
b.el.find("#plateau-jeu").fadeIn();b.resetGame(a)},500)};this.resetGame=function(a){this.tuto=-1;a&&(this.tuto=0);this.el.find("#plateau-jeu").removeClass("pendingCallback");this.centerAlert(!1);this.refreshVictoires();this.alertCallback=null;this.gameOver=!1;this.lockMise=!0;this.lockPiocher=this.lockPasser=this.isPlayerTurn=!1;this.mise=this.startMise;this.total=0;this.pioche="pomme pomme pomme pomme pomme fromage fromage fromage fromage potionSante potionSante potionSante pokgard-voir-action pokgard-voir-action pokgard-voir-action pokgard-voir-action pokgard-voler-action pokgard-voler-action pokgard-voler-action pokgard-detruire-action pokgard-detruire-action".split(" ");
this.garde.reset();this.player.reset();a=c.rand(0,2);-1==this.tuto&&a&&(this.alert("garde-begin"),this.garde.miser()&&this.garde.piocher());this.garde.renderActions();this.player.renderActions();this.playerTurn(0==a);this.firstTime=!1};this.playerTurn=function(a,b){this.player.hasMise=b;this.isPlayerTurn=!0;this.lockPiocher=this.lockPasser=this.lockMise=!1;this.player.alreadyPioche=!1;this.checkMise(a)};this.checkMise=function(a){if(this.isPlayerTurn&&(this.player.getGold()<this.mise&&(this.lockMise=
!0),!this.manageTuto())){if(a)return this.alert("player-begin");this.player.hasMise?this.alert("player-turn-2"):this.player.getGold()>=this.mise?this.alert("player-turn"):this.alert("player-impossible")}};this.gardeTurn=function(){var a=this;this.alert("garde-turn");this.lockMise=!0;this.isPlayerTurn=!1;this.garde.miser()?c.then(function(){a.garde.manageIA()},300):(this.alert("garde-non-mise"),c.then(function(){a.playerTurn()}))};this.manageTuto=function(){var a=this;return 0==this.tuto?(this.lockPasser=
this.lockMise=!0,this.centerAlert(!0,function(){a.alert(["pokgard-tuto-0","pokgard-tuto-1","pokgard-tuto-2","pokgard-tuto-3"],function(){a.centerAlert(!1,function(){a.alert("pokgard-tuto-4");a.lockMise=!1;a.tuto=1})})}),!0):1==this.tuto?(this.tuto=2,this.lockPasser=this.lockMise=!0,this.player.hasMise=!1,this.centerAlert(!0,function(){a.alert(["pokgard-tuto-5","pokgard-tuto-6","pokgard-tuto-7","pokgard-tuto-8"],function(){a.centerAlert(!1,function(){a.alert("pokgard-tuto-9");a.player.hasMise=!0;a.tuto=
3})})}),!0):3==this.tuto?(a.tuto=4,this.lockPiocher=this.lockPasser=this.lockMise=!0,this.centerAlert(!0,function(){a.alert("pokgard-tuto-10 pokgard-tuto-11 pokgard-tuto-12 pokgard-tuto-13 pokgard-tuto-14 pokgard-tuto-15".split(" "),function(){a.centerAlert(!1,function(){a.alert("pokgard-tuto-16");a.player.hasMise=!0;a.tuto=5})})}),!0):5==this.tuto?(a.tuto=6,this.lockPasser=this.lockMise=!0,this.centerAlert(!0,function(){a.saved?a.alert(["pokgard-tuto-17","pokgard-tuto-18-2"],function(){a.centerAlert(!1,
function(){a.lockPasser=!1;a.lockPiocher=!1;a.tuto=-1;a.restoreState()})}):a.alert(["pokgard-tuto-17","pokgard-tuto-18"],function(){a.centerAlert(!1,function(){a.lockMise=!1;a.lockPasser=!1;a.lockPiocher=!1;a.player.hasMise=!1;a.checkMise()})})}),!0):!1};this.render=function(){g.templateSettings.variable="data";var a=g.template(k);this.el.html(a({text:this.Textes}));f.verticalCenter();this.el.find("legende #confirm").hide();this.el.find("legende #legendes").show();this.makeEvents()};this.loop=function(){this.jeuGardeLaunch&&
(b("carnet").hasClass("hide")||b("carnet").addClass("hide"),b("loupe").hasClass("hide")||b("loupe").addClass("hide"),this.refreshActions(),this.refreshTotal(),this.refreshMise(),this.el.find("legende #bourse .val").html(this.player.getGold()))};this.refreshMise=function(){this.player.firstMise?this.el.find("action#miser span#mise").html(this.startMise):this.el.find("action#miser span#mise").html(this.mise)};this.refreshTotal=function(){if(this.total)this.el.find("total").fadeIn();else return this.el.find("total").hide();
this.el.find("total montant").html(this.total);var a=1;this.total&&(a=Math.floor(Math.log(this.total)/Math.LN10+1));this.el.find("total montant").attr("digits",a);a=Math.ceil(17*this.total/2E3);17<a&&(a=17);this.el.find("total \x3e picture").attr("step",a)};this.refreshActions=function(){this.gameOver?this.el.find("#plateau-jeu action:not(.lock)").addClass("lock"):this.isPlayerTurn?(this.pendingAction?this.el.find("#gardeActions action").removeClass("lock"):this.el.find("#gardeActions action:not(.lock)").addClass("lock"),
this.lockMise?this.el.find("plateau #miser:not(.lock)").addClass("lock"):this.el.find("plateau #miser").removeClass("lock"),this.lockPasser?this.el.find("plateau #passer:not(.lock)").addClass("lock"):this.el.find("plateau #passer").removeClass("lock"),this.player.hasMise?(this.el.find("#playerActions action").removeClass("lock"),this.lockPiocher||5<=this.player.length()?this.el.find("plateau pioche action:not(.lock)").addClass("lock"):this.el.find("plateau pioche action").removeClass("lock")):(this.el.find("#playerActions action:not(.lock)").addClass("lock"),
this.el.find("plateau pioche action:not(.lock)").addClass("lock"))):(this.el.find("#gardeActions action:not(.lock)").addClass("lock"),this.el.find("plateau #miser:not(.lock)").addClass("lock"),this.el.find("plateau #passer:not(.lock)").addClass("lock"),this.el.find("#playerActions action:not(.lock)").addClass("lock"),this.el.find("plateau pioche action:not(.lock)").addClass("lock"))};this.refreshVictoires=function(){-1==this.but||-1<this.tuto?this.el.find("legende #victoires").hide():(this.el.find("legende #victoires").fadeIn(),
this.el.find("legende #victoires span.val").html(this.nbWin),this.el.find("legende #victoires span.max").html(this.but))};this.refreshScore=function(){var a=this.player.getPoints();this.el.find("legende #score span.val").html(a)};this.alert=function(a,b,d){var c=this;if(Array.isArray(a)){if(0==a.length)return;if(1<a.length){var e=a.splice(0,1);this.alert(e[0],function(){c.alert(a,b,d)},d);return}a=a[0]}a=this.Textes.get(a);d||(d=[]);for(e in d)a=a.replace("?",d[e]);this.el.find("plateau alert texte").html(a);
f.verticalCenter();b&&(this.alertCallback=b,this.el.find("#plateau-jeu").addClass("pendingCallback"))};this.centerAlert=function(a,b){a||void 0==a?this.el.find("#plateau-jeu alert:not(.end)").addClass("end"):this.el.find("#plateau-jeu alert").removeClass("end");b&&c.then(function(){b()},100)};this.makeEvents=function(){var a=this;this.el.find("#plateau-jeu").click(function(){if(a.alertCallback){var b=a.alertCallback;a.alertCallback=null;b()}});this.el.find("action#miser").click(function(){b(this).hasClass("lock")||
(a.player.miser(),a.checkMise())});this.el.find("action#passer").click(function(){b(this).hasClass("lock")||a.playerTurn&&a.gardeTurn()});this.el.find("action#piocher").click(function(){b(this).hasClass("lock")||(b(this).addClass("lock"),a.player.piocher())});this.el.find("#playerActions action").click(function(){b(this).hasClass("lock")||b(this).hasClass("pending")||-1==b(this).attr("type").indexOf("-action")||(a.closePending(),a.alert("player-use"),a.pendingAction=a.player.getCarte(b(this).attr("id")),
b(this).addClass("pending"),b(this).animate({top:"20%"},300))});this.el.find("#gardeActions action").click(function(){if(!b(this).hasClass("lock")&&a.pendingAction){var c=b(this).attr("id");a.player.use(a.pendingAction,a.garde.getCarte(c));a.closePending()}});this.el.contextmenu(function(){a.closePending();return!1});this.el.find("info#abandonner").click(function(){a.el.find("legende #confirm").show();a.el.find("legende #legendes").hide()});this.el.find("legende #confirm #oui").click(function(){a.abandon()});
this.el.find("legende #confirm #oui").hover(function(){b(this).find("case").addClass("coche")},function(){b(this).find("case").removeClass("coche")});this.el.find("legende #confirm #non").click(function(){a.el.find("legende #confirm").hide();a.el.find("legende #legendes").show()});this.el.find("legende #confirm #non").hover(function(){b(this).find("case").addClass("coche")},function(){b(this).find("case").removeClass("coche")});this.el.find("#accueil-jeu action#continuer").click(function(){a.firstTime?
a.launchGame():(a.el.find("#accueil-jeu").hide(),a.el.find("#plateau-jeu").fadeIn(),a.resetGame())});this.el.find("#accueil-jeu action#partir").click(function(){a.abandon()});this.el.find("#accueil-jeu action#regles").click(function(){a.firstTime?a.launchGame(!0):(a.el.find("#accueil-jeu").hide(),a.el.find("#plateau-jeu").fadeIn(),a.resetGame(!0))});this.el.find("info#regles").click(function(){-1<a.tuto||(a.saveState(),a.resetGame(!0))})};this.saveState=function(){this.saved={pioche:this.pioche,mise:this.mise,
total:this.total,player:{main:this.player.main,hasMise:this.player.hasMise},garde:{main:this.garde.main,gold:this.garde.gold},lockMise:this.lockMise,isPlayerTurn:this.isPlayerTurn}};this.restoreState=function(){this.pioche=this.saved.pioche;this.mise=this.saved.mise;this.total=this.saved.total;this.player.main=this.saved.player.main;this.garde.main=this.saved.garde.main;this.garde.gold=this.saved.garde.gold;this.lockMise=this.saved.lockMise;this.isPlayerTurn=this.saved.isPlayerTurn;var a=this;c.then(function(){a.player.renderActions();
a.garde.renderActions();a.isPlayerTurn?a.playerTurn(!1,a.saved.player.hasMise):a.gardeTurn()},300)};this.closePending=function(){if(this.pendingAction){var a=this.el.find("#playerActions action[id\x3d'"+this.pendingAction.id+"']");b(a).animate({top:"0"},300);b(a).removeClass("pending");this.pendingAction=null;this.checkMise()}};this.checkGameOver=function(){var a=this;if(5==this.player.length()||5==this.garde.length()){this.gameOver=!0;this.garde.montre();var b=this.player.getPoints(),d=this.garde.getPoints();
c.then(function(){a.centerAlert(!0,function(){b>d?(a.nbWin++,a.player.addGold(a.total),a.total=0,a.alert("player-win",function(){-1!=a.but&&a.nbWin>=a.but?(a.endJeuGarde(),a.onWin()):a.accueil()})):d>b?(a.garde.addGold(a.total),a.total=0,a.alert("player-lose",function(){a.fail()},[b,d])):a.alert("match-nul",function(){a.player.getGold()<a.startMise?a.fail():a.resetGame()})})});return!0}return!1};this.fail=function(){this.endJeuGarde();this.onFail()};this.abandon=function(){this.endJeuGarde();this.onAbandon()};
this.endJeuGarde=function(){this.jeuGardeLaunch=!1;b(".ui").fadeIn();b("carnet").removeClass("hide");b("loupe").removeClass("hide")};this.init(l)}});