define(["jquery","underscore","app/utils/utils","app/utils/viewUtils","text!app/template/menu/popup/traductions.html"],function(c,k,l,p,m){return function(n){this.init=function(a){this.el=c(".traductions-popup");this.parent=a;this.Textes=a.Textes;this.mediatheque=a.mediatheque;this.saveManager=a.saveManager;this.render();this.el.hide()};this.render=function(){k.templateSettings.variable="data";var a=k.template(m);this.el.html(a({text:this.Textes}));this.makeEvents()};this.showFiles=function(){this.currentFile=
null;this.el.find("content#textes").hide();this.el.find("content#fichiers files").empty();this.files=[];this.addFile(this.Textes);this.el.find("content#fichiers").fadeIn();this.el.fadeIn();this.makeFileEvents()};this.addFile=function(a){if(a.list().length){this.files[a.name()]=a;var b=c("\x3cfile\x3e\x3c/file\x3e");b.html(a.name());this.el.find("content#fichiers files").append(b)}a=a.children();for(var d in a)this.addFile(a[d])};this.showFile=function(a){this.currentFile=a;this.el.find("content#fichiers").hide();
this.source||(this.source=this.Textes.loadLocal());this.cible||(this.cible="fr"==this.source?"en":"eo");this.refreshTrads();this.el.find("content#textes").fadeIn();this.el.fadeIn()};this.refreshTrads=function(){if(this.currentFile){var a=this.currentFile.list(),b=this.source,d=this.cible;this.el.find("#textes langage#source").attr("name",b);this.el.find("#textes langage#cible").attr("name",d);this.el.find("textes").empty();for(var k in a){var f=a[k],g=c("\x3ctext\x3e\x3c/text\x3e");this.el.find("textes").append(g);
g.attr("name",f);var e=c("\x3cdiv class\x3d'checkContainer'\x3e\x3c/span\x3e");e.append(c("\x3cspan class\x3d'verify'\x3e\x3c/span\x3e"));e.append(c("\x3cspan class\x3d'delete'\x3e\x3c/span\x3e"));g.append(e);var h=this.Textes.get(f,b,b!=d),h=l.decodeHtml(h),e=c("\x3cspan class\x3d'source'\x3e\x3c/span\x3e");e.html(h);g.append(e);(h=this.saveManager.myTrad(f,d))?g.addClass("check"):h=this.Textes.get(f,d);f=l.decodeHtml(h);35<e.text().length||35<f.length?(e=c("\x3ctextarea\x3e\x3c/textarea\x3e"),e.html(f),
g.addClass("large")):(g.append("\x26nbsp;-\x3e\x26nbsp;"),e=c("\x3cinput type\x3d'text'/\x3e"),e.attr("value",f));g.append(e)}var m=this;l.then(function(){m.onResize()},20);this.makeTextEvents()}};this.onResize=function(){this.el.find("textes textarea").each(function(a,b){c(this).css("height",0);c(this).css("height",this.scrollHeight+5)})};this.makeTextEvents=function(){var a=this;this.el.find("textes text input, textes text textarea").keypress(function(){c(this).parent().addClass("check");var b=
a.el.find("langage#cible.selected").attr("name"),d=c(this).parent().attr("name");a.saveManager.addTrad(d,b,c(this).val(),!0)});this.el.find("textes text input, textes text textarea").change(function(){var b=a.el.find("langage#cible.selected").attr("name"),d=c(this).parent().attr("name");a.saveManager.addTrad(d,b,c(this).val())});this.el.find("textes text span.delete").click(function(){var b=a.el.find("langage#cible.selected").attr("name"),d=c(this).parent().parent().attr("name");a.saveManager.deleteTrad(d,
b);a.refreshTrads()})};this.makeFileEvents=function(){var a=this;this.el.find("file").click(function(){var b=c(this).html();a.showFile(a.files[b])})};this.makeEvents=function(){var a=this;this.el.find("content#fichiers .canClose").click(function(b){c(b.target).hasClass("canClose")&&(a.el.fadeOut(),a.parent.refreshTextes())});this.el.find("content#textes .canClose").click(function(b){c(b.target).hasClass("canClose")&&(a.parent.refreshTextes(),a.showFiles())});this.el.find("langage.selected").click(function(b){b=
a.el.find("content#textes");var d=c(this);a.langageInChange=d.attr("id");b.find("langages").is(":visible")?b.find("langages").hide():(d=d.position().left,b.find("langages").css({left:l.toPercent(d,b.width())+"%"}),b.find("langages").show())});this.el.find("#textes langages langage").off("click");this.el.find("#textes langages langage").click(function(b){a.el.find("#textes langages").hide();a.current=c(this).attr("name");"source"==a.langageInChange?a.source=a.current:a.cible=a.current;a.refreshTrads()});
this.el.find("bouton#send").click(function(b){a.saveManager.sendTrad(a)})};this.refreshTextes=function(){this.el.find("langages span.source").html(this.Textes.get("traduction-source"));this.el.find("langages span.cible").html(this.Textes.get("traduction-cible"));this.el.find("langages option[name\x3d'fr']").html(this.Textes.get("french"));this.el.find("langages option[name\x3d'en']").html(this.Textes.get("english"));this.el.find("langages option[name\x3d'eo']").html(this.Textes.get("esperanto"));
this.el.find("boutons #send").html(this.Textes.get("traduction-submit"))};this.init(n)}});